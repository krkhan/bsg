##! This script analyzes inbound and outbound scanning activities.
##! Inbound scanning can be a very elementray sign of botnet infection. 
##! Outbound scan contributes to attack phase of botnet infection.
##! This script evokes events related to inbound and outbound scan.

@load ./pre-scan

module Botflex_scan;

export {
	## This script generates two logs, one for inbound and
	## another for outbound scannning
	redef enum Log::ID += { LOG_IB, LOG_OB };

	type Info_ib: record {
		ts:                time             &log;
		src_ip:            addr             &log;
		scan_type:         string	    &log;
		num_ports_scanned: count            &log;
		num_addrs_scanned: count            &log;
		target_port:	   port             &log;
		msg:		   string	    &log;
		victims:           string           &log;
		
	};

	type Info_ob: record {
		ts:                time             &log;
		src_ip:            addr             &log;
		scan_type:         string	    &log;
		num_ports_scanned: count            &log;
		num_addrs_scanned: count            &log;
		target_port:	   port             &log;
		msg:		   string	    &log;
		
	};
	
	redef record connection += {
	conn: Info_ib &optional;};

	redef record connection += {
	conn: Info_ob &optional;};

	## Event that can be handled to access the scan
	## record as it is sent on to the logging framework.
	global log_scan_ib: event(rec: Info_ib);
	global log_scan_ob: event(rec: Info_ob);

	## The event that sufficient evidence has been gathered to declare the inbound 
	## scan or attack (in case of outbound scan) phase of botnet infection lifecycle
	global scan_ib: event( ts: time, src_ip: addr, victim: addr, target_port: port, msg: string );
	global scan_ob: event( ts: time, src_ip: addr, target_port: port, msg: string );

	global log_scan: event( ts: time, src_ip: addr, scan_type: string, num_ports_scanned: count,
	       num_addrs_scanned: count, target_port: port, msg: string, victims: string, outbound: bool );
}

event bro_init() &priority=5
	{
	Log::create_stream(Botflex_scan::LOG_IB, [$columns=Info_ib, $ev=log_scan_ib]);
	Log::create_stream(Botflex_scan::LOG_OB, [$columns=Info_ob, $ev=log_scan_ob]);
	
	}
global scan_ib_info: Botflex_scan::Info_ib;
global scan_ob_info: Botflex_scan::Info_ob;

## Hooking into notices of interest generated by pre-scan.bro
redef Notice::policy += {
       [$pred(n: Notice::Info) = {
	       local outbound: bool;  
	       
               if ( n$note == Scan::PortScan )
                       {
			outbound = Site::is_local_addr(n$src);
			if ( outbound )
				{
				event scan_ob( network_time(), n$src, n$p, n$msg );
				event Botflex_scan::log_scan(network_time(), n$src, "Port Scan", n$n, 0, n$p, 
						              n$msg, "", T );
				}
			else
				{
				event scan_ib( network_time(), n$src, n$dst, n$p, n$msg );
				event Botflex_scan::log_scan(network_time(), n$src, "Port Scan", n$n, 0, n$p, 
						              n$msg, fmt("%s", n$dst), F );
				}
                       }

               else if ( n$note == Scan::AddressScanOutbound )
                       {
			local m1 = fmt("%s: %s",n$msg, n$sub);
			event scan_ob( network_time(), n$src, n$p, m1 ); 
			event Botflex_scan::log_scan(network_time(), n$src, "Address Scan", 0, n$n, n$p, 
						      m1, "", T );	
                       }

		else if ( n$note == Scan::AddressScanInbound )
                       {
			# n$msg has the form <the msg>:<victim1 victim2 victim3..>
			local msg_arr = split(n$msg, /[:]/);
			local str_victims = split( msg_arr[2], /[[:blank:]]*/ );
			for ( v in str_victims )
				{
				event scan_ib( network_time(), n$src, to_addr(str_victims[v]), n$p, n$msg );
				}
			event Botflex_scan::log_scan(network_time(), n$src, "Address Scan", n$n, 0, n$p, 
						      fmt("%s: %s",msg_arr[1], n$sub), msg_arr[2], F );

                       }

	       else if ( n$note == Scan::LowPortTrolling )
                       {
			outbound = Site::is_local_addr(n$src);
			if ( outbound )
				{
				local m3 = fmt("%s: %s", n$msg, "critical");
				event scan_ob( network_time(), n$src, n$p, m3 );
				event Botflex_scan::log_scan(network_time(), n$src, "Port Scan", n$n, 0, n$p, 
						      m3, "", T );
				}
			else
				{
				local m2 = fmt("%s: %s", n$msg, "critical");
				event scan_ib( network_time(), n$src, n$dst, n$p, m2 );
				event Botflex_scan::log_scan(network_time(), n$src, "Port Scan", n$n, 0, n$p, 
						      m2, fmt("%s", n$dst), F );
				}
                       }
	
       }]
};

event say_hello( str: string)
	{
	print fmt("Hello %s",str);
	}


# Logging scan information. The last parameter <outbound> specifies which
# log the information will be written to
event log_scan( ts: time, src_ip: addr, scan_type: string, num_ports_scanned: count,
	       num_addrs_scanned: count, target_port: port, msg: string, victims: string, outbound: bool )
	{
	if ( outbound )
		{
		scan_ob_info$ts = ts;
		scan_ob_info$src_ip = src_ip;
		scan_ob_info$scan_type = scan_type;
		scan_ob_info$num_ports_scanned = num_ports_scanned;
		scan_ob_info$num_addrs_scanned = num_addrs_scanned;
		#scan_ob_info$target_port = target_port;
		scan_ob_info$msg = msg;

		Log::write(Botflex_scan::LOG_OB, Botflex_scan::scan_ob_info );
		}
	else
		{
		scan_ib_info$ts = ts;
		scan_ib_info$src_ip = src_ip;
		scan_ib_info$scan_type = scan_type;
		scan_ib_info$num_ports_scanned = num_ports_scanned;
		scan_ib_info$num_addrs_scanned = num_addrs_scanned;
		scan_ib_info$target_port = target_port;
		scan_ib_info$msg = msg;
		scan_ib_info$victims = victims;

		Log::write(Botflex_scan::LOG_IB, Botflex_scan::scan_ib_info );
		}
	}


