##! This script analyzes attack behavior of potential bots. For the
##! time being, we look at spam and a coarse analysis of DDoS like 
##! activity.

module Exploit;

export {
	redef enum Log::ID += { LOG };

	type Info: record {
		ts:                time              &log;
		victim_ip:         addr              &log;
		msg:               string            &log;
		
	};
	
	redef record connection += {
	conn: Info &optional;
	};
	
	## Event that can be handled to access the bot_attack
	## record as it is sent on to the logging framework.
	global log_exploit: event(rec: Info);

	## The event that spam.bro reported spam
	global breakin: event( victim_ip: addr, attackers: string );
       }

## Type of the value of the global table table_bot_attack
## Additional contributary factors that increase the confidence
## about major event bot_attack should be added here 
type ExploitRecord: record {
	score_breakin: bool;     	
};

## The event that sufficient evidence has been gathered to declare the
## bot_attack phase of botnet infection lifecycle
global exploit: event( ts: time, victim_ip: addr, msg: string );

event bro_init() &priority=5
	{
	Log::create_stream( Exploit::LOG, [$columns=Info, $ev=log_exploit] );
	}
global exploit_info:Exploit::Info;

## The function that decides whether or not the major event bot_attack should
## be generated. It is called (i) every time an entry in the global table 
## table_bot_attack reaches certain age defined by the table attribute &create_expire,
## or (ii) Any of the counters for a source ip exceed their fixed thresholds. 

function evaluate( victim_ip: addr, t: table[addr] of ExploitRecord )
	{
	if( t[victim_ip]$score_breakin )
		{
		local msg = "";
  		if( t[victim_ip]$score_breakin )
			msg = msg + "Breakin,";
		
    		event exploit( network_time(), victim_ip, msg );		

		## Log bot_attack related entries
		exploit_info$ts = network_time();
		exploit_info$victim_ip = victim_ip;
		exploit_info$msg = msg;

		Log::write(Exploit::LOG,exploit_info);

		## Get rid of the record
		delete t[victim_ip];
		}
	}

## Called when an entry in the global table table_bot_attack exceeds certain age, as specified
## in the table attribute create_expire.
function exploit_record_expired(t: table[addr] of ExploitRecord, idx: any): interval
	{
	evaluate( idx, t );
	return 0secs;
	}


## The global state table that maintains various information pertaining to the
## major event cnc, and is analyzed when a decision has to be made whether
## or not to declare the major event cnc.
global table_exploit: table[addr] of ExploitRecord &create_expire=45mins &expire_func=exploit_record_expired;

event breakin( victim_ip: addr, attackers: string )
	{
	if ( victim_ip !in table_exploit )
		{
		local rec: ExploitRecord;
		rec$score_breakin = F;

		table_exploit[victim_ip] = rec;
		}

	# Update sqli score
	table_exploit[victim_ip]$score_breakin = T;	
	
	evaluate( victim_ip, table_exploit );	
	}
